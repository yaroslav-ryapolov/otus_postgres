# ДЗ 06. Работа с журналами (по лекции 09.  Журналы)

Создал виртуальную машину **otus-vm-06** в Yandex Cloud согласно [инструкции](../00.Common/01.YC_start.md). Версию PostgreSQL для установки выбираем **14**.

## 1. Контрольные точки

**1.1** Настроил выполнение контрольной точки раз в 30 секунд (изначально было настроено на раз в 5 минут) и перечитал конфигурацию для инстанса:

```sql
-- Утилита psql (пользователь postgres)
postgres=# show checkpoint_timeout;
 checkpoint_timeout
--------------------
 5min
(1 row)

postgres=# alter system set checkpoint_timeout = '30s';
ALTER SYSTEM

postgres=# select pg_reload_conf();
 pg_reload_conf
----------------
 t
(1 row)

postgres=# show checkpoint_timeout;
 checkpoint_timeout
--------------------
 30s
(1 row)
```

**1.2** Включил логирование информации о чекпоинтах:

```sql
-- Утилита psql (пользователь postgres)
postgres=# show log_checkpoints;
 log_checkpoints
-----------------
 off
(1 row)

postgres=# alter system set log_checkpoints = on;
ALTER SYSTEM

postgres=# select pg_reload_conf();
 pg_reload_conf
----------------
 t
(1 row)

postgres=# show log_checkpoints;
 log_checkpoints
-----------------
 on
(1 row)
```

**1.3** Запоминл текущее значение счетчика журнала:

```sql
-- Утилита psql (пользователь postgres)
postgres=# select pg_current_wal_insert_lsn(), pg_current_wal_lsn(), pg_current_wal_flush_lsn();
 pg_current_wal_insert_lsn | pg_current_wal_lsn | pg_current_wal_flush_lsn
---------------------------+--------------------+--------------------------
 0/1DAB7A48                | 0/1DAB7A48         | 0/1DAB7A48
(1 row)
```

**1.4** В течение 10 минут подавал нагрузку утилитой [`pgbench`](https://www.postgresql.org/docs/15/pgbench.html) со следующими настройками:

| Имя параметра | Значение |
|---------------|----------|
|-с8| Эмулируем 8 параллельно работающих клиентов |
|-P 6| Вывод информации о прогрессе каждые 6 секунд|
|-T 600| Выполнять нагрузку на протяжении 600 секунд (10 минут)|
|postgres| Имя БД, на которой необходимо выполнять нагрузку|

Для этого предварительно выполнил инициализацию таблиц для утилиты командой:

```bash
# SSH-сессия на виртуальной машине
vm:~$ sudo -u postgres pgbench -i postgres
dropping old tables...
NOTICE:  table "pgbench_accounts" does not exist, skipping
NOTICE:  table "pgbench_branches" does not exist, skipping
NOTICE:  table "pgbench_history" does not exist, skipping
NOTICE:  table "pgbench_tellers" does not exist, skipping
creating tables...
generating data (client-side)...
100000 of 100000 tuples (100%) done (elapsed 0.09 s, remaining 0.00 s)
vacuuming...
creating primary keys...
done in 1.15 s (drop tables 0.00 s, create tables 0.01 s, client-side generate 0.12 s, vacuum 0.04 s, primary keys 0.99 s).
```

Результат выполнения нагрузки:

```bash
# SSH-сессия на виртуальной машине
vm:~$ sudo -u postgres pgbench -c8 -P 6 -T 600 postgres
pgbench (14.11 (Ubuntu 14.11-1.pgdg20.04+1))
starting vacuum...end.
progress: 6.0 s, 549.1 tps, lat 14.463 ms stddev 11.309
progress: 12.0 s, 631.8 tps, lat 12.626 ms stddev 9.231
progress: 18.0 s, 383.7 tps, lat 20.771 ms stddev 23.099
...
progress: 588.0 s, 396.2 tps, lat 20.163 ms stddev 23.392
progress: 594.0 s, 588.2 tps, lat 13.559 ms stddev 9.776
progress: 600.0 s, 627.0 tps, lat 12.678 ms stddev 9.305
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 1
query mode: simple
number of clients: 8
number of threads: 1
duration: 600 s
number of transactions actually processed: 321287
latency average = 14.906 ms
latency stddev = 13.472 ms
initial connection time = 23.879 ms
tps = 535.472331 (without initial connection time)
```

**1.5** Снова получил текущие значение счетчика журнала:

```sql
-- Утилита psql (пользователь postgres)
postgres=# select pg_current_wal_insert_lsn(), pg_current_wal_lsn(), pg_current_wal_flush_lsn();
 pg_current_wal_insert_lsn | pg_current_wal_lsn | pg_current_wal_flush_lsn
---------------------------+--------------------+--------------------------
 0/38933F40                | 0/38933F40         | 0/38933F40
(1 row)
```

**1.6** Проверил статистику сделанных чекпоинтов:

```sql
-- Утилита psql (пользователь postgres)
postgres=#  select * from pg_stat_bgwriter \gx
-[ RECORD 1 ]---------+------------------------------
checkpoints_timed     | 54
checkpoints_req       | 0
checkpoint_write_time | 1129786
checkpoint_sync_time  | 1197
buffers_checkpoint    | 83383
buffers_clean         | 0
maxwritten_clean      | 0
buffers_backend       | 6030
buffers_backend_fsync | 0
buffers_alloc         | 6609
stats_reset           | 2024-04-06 09:56:54.693435+00
```

Здесь проявился интересный момент, что счетчик `chepoints_timed` наращивается даже в случае, если никаких изменений не было сделано и реальных данных в чекпоинт записано не было а в логах никакой дополнительной информации не появилось. При этом остальные значения (buffers_backend, buffers_checkpoint и прочие) не изменяются. При этом информация в логе:

```bash
# SSH-сессия на виртуальной машине
vm:~$ sudo tail -n 150 /var/log/postgresql/postgresql-14-main.log
...
2024-04-06 10:20:58.439 UTC [4069] LOG:  checkpoint starting: time
2024-04-06 10:21:25.113 UTC [4069] LOG:  checkpoint complete: wrote 1863 buffers (11.4%); 0 WAL file(s) added, 0 removed, 1 recycled; write=26.587 s, sync=0.040 s, total=26.674 s; sync files=19, longest=0.013 s, average=0.003 s; distance=17300 kB, estimate=21445 kB
2024-04-06 10:21:28.116 UTC [4069] LOG:  checkpoint starting: time
2024-04-06 10:21:55.076 UTC [4069] LOG:  checkpoint complete: wrote 1930 buffers (11.8%); 0 WAL file(s) added, 0 removed, 2 recycled; write=26.886 s, sync=0.024 s, total=26.960 s; sync files=14, longest=0.016 s, average=0.002 s; distance=21624 kB, estimate=21624 kB
2024-04-06 10:21:58.079 UTC [4069] LOG:  checkpoint starting: time
2024-04-06 10:22:25.142 UTC [4069] LOG:  checkpoint complete: wrote 1917 buffers (11.7%); 0 WAL file(s) added, 0 removed, 1 recycled; write=26.989 s, sync=0.023 s, total=27.064 s; sync files=7, longest=0.009 s, average=0.004 s; distance=21824 kB, estimate=21824 kB
2024-04-06 10:22:28.144 UTC [4069] LOG:  checkpoint starting: time
2024-04-06 10:22:55.083 UTC [4069] LOG:  checkpoint complete: wrote 1982 buffers (12.1%); 0 WAL file(s) added, 0 removed, 1 recycled; write=26.884 s, sync=0.018 s, total=26.940 s; sync files=16, longest=0.011 s, average=0.002 s; distance=21108 kB, estimate=21752 kB
2024-04-06 10:22:58.084 UTC [4069] LOG:  checkpoint starting: time
2024-04-06 10:23:25.135 UTC [4069] LOG:  checkpoint complete: wrote 1930 buffers (11.8%); 0 WAL file(s) added, 0 removed, 1 recycled; write=26.986 s, sync=0.031 s, total=27.051 s; sync files=8, longest=0.013 s, average=0.004 s; distance=21771 kB, estimate=21771 kB
2024-04-06 10:23:28.136 UTC [4069] LOG:  checkpoint starting: time
2024-04-06 10:23:55.117 UTC [4069] LOG:  checkpoint complete: wrote 2012 buffers (12.3%); 0 WAL file(s) added, 0 removed, 2 recycled; write=26.902 s, sync=0.030 s, total=26.981 s; sync files=14, longest=0.017 s, average=0.003 s; distance=21788 kB, estimate=21788 kB
2024-04-06 10:23:58.120 UTC [4069] LOG:  checkpoint starting: time
2024-04-06 10:24:25.101 UTC [4069] LOG:  checkpoint complete: wrote 1896 buffers (11.6%); 0 WAL file(s) added, 0 removed, 1 recycled; write=26.901 s, sync=0.034 s, total=26.981 s; sync files=8, longest=0.016 s, average=0.005 s; distance=21593 kB, estimate=21768 kB
2024-04-06 10:24:28.104 UTC [4069] LOG:  checkpoint starting: time
2024-04-06 10:24:55.064 UTC [4069] LOG:  checkpoint complete: wrote 1998 buffers (12.2%); 0 WAL file(s) added, 0 removed, 1 recycled; write=26.886 s, sync=0.026 s, total=26.961 s; sync files=15, longest=0.018 s, average=0.002 s; distance=21340 kB, estimate=21726 kB
2024-04-06 10:24:58.067 UTC [4069] LOG:  checkpoint starting: time
2024-04-06 10:25:25.155 UTC [4069] LOG:  checkpoint complete: wrote 1867 buffers (11.4%); 0 WAL file(s) added, 0 removed, 2 recycled; write=26.983 s, sync=0.031 s, total=27.089 s; sync files=8, longest=0.013 s, average=0.004 s; distance=21080 kB, estimate=21661 kB
2024-04-06 10:25:28.158 UTC [4069] LOG:  checkpoint starting: time
2024-04-06 10:25:55.138 UTC [4069] LOG:  checkpoint complete: wrote 2010 buffers (12.3%); 0 WAL file(s) added, 0 removed, 1 recycled; write=26.911 s, sync=0.022 s, total=26.981 s; sync files=15, longest=0.014 s, average=0.002 s; distance=21341 kB, estimate=21629 kB
2024-04-06 10:25:58.140 UTC [4069] LOG:  checkpoint starting: time
2024-04-06 10:26:25.102 UTC [4069] LOG:  checkpoint complete: wrote 1888 buffers (11.5%); 0 WAL file(s) added, 0 removed, 1 recycled; write=26.891 s, sync=0.030 s, total=26.963 s; sync files=10, longest=0.012 s, average=0.003 s; distance=21277 kB, estimate=21594 kB
2024-04-06 10:26:28.105 UTC [4069] LOG:  checkpoint starting: time
2024-04-06 10:26:55.114 UTC [4069] LOG:  checkpoint complete: wrote 1997 buffers (12.2%); 0 WAL file(s) added, 0 removed, 2 recycled; write=26.913 s, sync=0.022 s, total=27.009 s; sync files=16, longest=0.014 s, average=0.002 s; distance=21479 kB, estimate=21582 kB
2024-04-06 10:26:58.117 UTC [4069] LOG:  checkpoint starting: time
2024-04-06 10:27:25.078 UTC [4069] LOG:  checkpoint complete: wrote 1889 buffers (11.5%); 0 WAL file(s) added, 0 removed, 1 recycled; write=26.886 s, sync=0.025 s, total=26.962 s; sync files=9, longest=0.012 s, average=0.003 s; distance=21418 kB, estimate=21566 kB
2024-04-06 10:27:28.081 UTC [4069] LOG:  checkpoint starting: time
2024-04-06 10:27:55.051 UTC [4069] LOG:  checkpoint complete: wrote 1956 buffers (11.9%); 0 WAL file(s) added, 0 removed, 1 recycled; write=26.897 s, sync=0.018 s, total=26.970 s; sync files=13, longest=0.018 s, average=0.002 s; distance=20843 kB, estimate=21494 kB
2024-04-06 10:27:58.052 UTC [4069] LOG:  checkpoint starting: time
2024-04-06 10:28:25.129 UTC [4069] LOG:  checkpoint complete: wrote 1880 buffers (11.5%); 0 WAL file(s) added, 0 removed, 2 recycled; write=26.989 s, sync=0.028 s, total=27.078 s; sync files=7, longest=0.015 s, average=0.004 s; distance=21175 kB, estimate=21462 kB
2024-04-06 10:28:28.132 UTC [4069] LOG:  checkpoint starting: time
2024-04-06 10:28:55.122 UTC [4069] LOG:  checkpoint complete: wrote 2146 buffers (13.1%); 0 WAL file(s) added, 0 removed, 1 recycled; write=26.900 s, sync=0.031 s, total=26.990 s; sync files=15, longest=0.017 s, average=0.003 s; distance=20904 kB, estimate=21406 kB
2024-04-06 10:28:58.125 UTC [4069] LOG:  checkpoint starting: time
2024-04-06 10:29:25.080 UTC [4069] LOG:  checkpoint complete: wrote 1882 buffers (11.5%); 0 WAL file(s) added, 0 removed, 1 recycled; write=26.885 s, sync=0.020 s, total=26.956 s; sync files=7, longest=0.012 s, average=0.003 s; distance=21124 kB, estimate=21378 kB
2024-04-06 10:29:28.083 UTC [4069] LOG:  checkpoint starting: time
2024-04-06 10:29:55.154 UTC [4069] LOG:  checkpoint complete: wrote 1979 buffers (12.1%); 0 WAL file(s) added, 0 removed, 1 recycled; write=26.980 s, sync=0.042 s, total=27.072 s; sync files=12, longest=0.042 s, average=0.004 s; distance=21320 kB, estimate=21372 kB
2024-04-06 10:29:58.156 UTC [4069] LOG:  checkpoint starting: time
2024-04-06 10:30:25.136 UTC [4069] LOG:  checkpoint complete: wrote 1857 buffers (11.3%); 0 WAL file(s) added, 0 removed, 2 recycled; write=26.892 s, sync=0.025 s, total=26.980 s; sync files=8, longest=0.011 s, average=0.004 s; distance=21195 kB, estimate=21354 kB
2024-04-06 10:30:28.139 UTC [4069] LOG:  checkpoint starting: time
2024-04-06 10:30:55.092 UTC [4069] LOG:  checkpoint complete: wrote 2173 buffers (13.3%); 0 WAL file(s) added, 0 removed, 1 recycled; write=26.895 s, sync=0.019 s, total=26.953 s; sync files=16, longest=0.011 s, average=0.002 s; distance=21504 kB, estimate=21504 kB
2024-04-06 10:31:28.125 UTC [4069] LOG:  checkpoint starting: time
2024-04-06 10:31:55.054 UTC [4069] LOG:  checkpoint complete: wrote 1869 buffers (11.4%); 0 WAL file(s) added, 0 removed, 1 recycled; write=26.905 s, sync=0.010 s, total=26.929 s; sync files=13, longest=0.007 s, average=0.001 s; distance=17866 kB, estimate=21140 kB
```

**1.6** Используя значения счетчиков из пунктов **1.3** и **1.5**






















